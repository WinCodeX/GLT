<!-- app/views/admin/updates/show.html.erb -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update v<%= @update.version %> - Admin Portal</title>
    <meta name="csrf-token" content="<%= form_authenticity_token %>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            color: white;
            padding: 30px;
            position: relative;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-info {
            flex: 1;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-header {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-header:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }

        .btn-header.primary {
            background: rgba(16, 185, 129, 0.8);
            border-color: rgba(16, 185, 129, 1);
        }

        .btn-header.danger {
            background: rgba(239, 68, 68, 0.8);
            border-color: rgba(239, 68, 68, 1);
        }

        .status-indicator {
            position: absolute;
            top: 20px;
            right: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .status-published {
            background: rgba(16, 185, 129, 0.8);
            color: white;
        }

        .status-draft {
            background: rgba(245, 158, 11, 0.8);
            color: white;
        }

        .content {
            padding: 40px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .info-card {
            background: #f8fafc;
            border-radius: 15px;
            padding: 25px;
            border-left: 4px solid #8B5CF6;
        }

        .info-card h3 {
            color: #1f2937;
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .info-item:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #6b7280;
            font-size: 0.9rem;
        }

        .info-value {
            color: #1f2937;
            font-weight: 500;
        }

        .changelog-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .changelog-section h3 {
            color: #1f2937;
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .changelog-list {
            list-style: none;
            padding: 0;
        }

        .changelog-item {
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .changelog-item:last-child {
            border-bottom: none;
        }

        .changelog-bullet {
            width: 8px;
            height: 8px;
            background: #8B5CF6;
            border-radius: 50%;
            margin-top: 8px;
            flex-shrink: 0;
        }

        .changelog-text {
            color: #374151;
            line-height: 1.6;
        }

        .apk-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .apk-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }

        .apk-details {
            flex: 1;
        }

        .apk-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .force-update-warning {
            background: #fef2f2;
            border: 2px solid #fecaca;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .force-update-warning .icon {
            color: #dc2626;
            font-size: 1.2rem;
        }

        .force-update-warning .text {
            color: #dc2626;
            font-weight: 600;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #8B5CF6;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 600;
        }

        .metadata-section {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .metadata-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .metadata-label {
            font-size: 0.8rem;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 600;
        }

        .metadata-value {
            color: #1f2937;
            font-weight: 500;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .no-apk {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .no-apk-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .danger-zone {
            border: 2px solid #fecaca;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            background: #fef2f2;
        }

        .danger-zone h3 {
            color: #dc2626;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .danger-zone p {
            color: #7f1d1d;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .apk-info {
                flex-direction: column;
                text-align: center;
            }
            
            .stats-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: #10b981;
        }

        .toast.error {
            background: #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="status-indicator">
                <div class="status-badge <%= @update.published? ? 'status-published' : 'status-draft' %>">
                    <%= @update.published? ? 'Published' : 'Draft' %>
                </div>
                <% if @update.force_update %>
                    <div class="status-badge" style="background: rgba(239, 68, 68, 0.8);">
                        Force Update
                    </div>
                <% end %>
            </div>
            
            <div class="header-content">
                <div class="header-info">
                    <h1>Update v<%= @update.version %></h1>
                    <p>Runtime Version: <%= @update.runtime_version %> ‚Ä¢ Created <%= time_ago_in_words(@update.created_at) %> ago</p>
                </div>
                
                <div class="header-actions">
                    <a href="<%= admin_updates_path %>" class="btn-header">
                        ‚Üê Back to Updates
                    </a>
                    <% unless @update.published? %>
                        <a href="<%= edit_admin_update_path(@update) %>" class="btn-header">
                            ‚úèÔ∏è Edit
                        </a>
                        <% if @update.apk_url.present? %>
                            <button onclick="publishUpdate()" class="btn-header primary">
                                üöÄ Publish
                            </button>
                        <% end %>
                    <% else %>
                        <button onclick="unpublishUpdate()" class="btn-header">
                            üì§ Unpublish
                        </button>
                    <% end %>
                </div>
            </div>
        </div>

        <div class="content">
            <!-- Update Information -->
            <div class="info-grid">
                <div class="info-card">
                    <h3>üìã Update Details</h3>
                    <div class="info-item">
                        <span class="info-label">Version</span>
                        <span class="info-value">v<%= @update.version %></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Runtime Version</span>
                        <span class="info-value"><%= @update.runtime_version %></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Status</span>
                        <span class="info-value">
                            <%= @update.published? ? 'Published' : 'Draft' %>
                            <% if @update.published_at %>
                                (<%= @update.published_at.strftime("%b %d, %Y at %I:%M %p") %>)
                            <% end %>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Force Update</span>
                        <span class="info-value"><%= @update.force_update? ? 'Yes' : 'No' %></span>
                    </div>
                </div>

                <div class="info-card">
                    <h3>üìä Statistics</h3>
                    <div class="info-item">
                        <span class="info-label">Downloads</span>
                        <span class="info-value"><%= @update.download_count %></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Created</span>
                        <span class="info-value">
                            <%= @update.created_at.strftime("%b %d, %Y") %>
                            (<%= @created_days_ago %> days ago)
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Update ID</span>
                        <span class="info-value" style="font-family: 'Courier New', monospace; font-size: 0.8rem;">
                            <%= @update.update_id %>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Force Update Warning -->
            <% if @update.force_update %>
                <div class="force-update-warning">
                    <span class="icon">‚ö†Ô∏è</span>
                    <span class="text">This is a force update. Users will be required to install it before using the app.</span>
                </div>
            <% end %>

            <!-- Description -->
            <% if @update.description.present? %>
                <div class="changelog-section">
                    <h3>üìù Description</h3>
                    <p style="color: #374151; line-height: 1.6;"><%= @update.description %></p>
                </div>
            <% end %>

            <!-- Changelog -->
            <% if @update.changelog.present? && @update.changelog.any? %>
                <div class="changelog-section">
                    <h3>üîÑ What's New</h3>
                    <ul class="changelog-list">
                        <% @update.changelog.each do |item| %>
                            <li class="changelog-item">
                                <div class="changelog-bullet"></div>
                                <div class="changelog-text"><%= item %></div>
                            </li>
                        <% end %>
                    </ul>
                </div>
            <% end %>

            <!-- APK Information -->
            <div class="apk-section">
                <h3>üì¶ APK Information</h3>
                
                <% if @update.apk_url.present? %>
                    <div class="apk-info">
                        <div class="apk-details">
                            <div class="info-item" style="margin-bottom: 10px;">
                                <span class="info-label">APK URL</span>
                                <span class="info-value" style="font-family: 'Courier New', monospace; font-size: 0.8rem; word-break: break-all;">
                                    <%= @update.apk_url %>
                                </span>
                            </div>
                            <% if @update.apk_key.present? %>
                                <div class="info-item" style="margin-bottom: 10px;">
                                    <span class="info-label">APK Key</span>
                                    <span class="info-value" style="font-family: 'Courier New', monospace; font-size: 0.8rem;">
                                        <%= @update.apk_key %>
                                    </span>
                                </div>
                            <% end %>
                            <% if @update.apk_filename.present? %>
                                <div class="info-item" style="margin-bottom: 10px;">
                                    <span class="info-label">Filename</span>
                                    <span class="info-value">
                                        <%= @update.apk_filename %>
                                    </span>
                                </div>
                            <% end %>
                            <% if @update.apk_size.present? %>
                                <div class="info-item">
                                    <span class="info-label">APK Size</span>
                                    <span class="info-value">
                                        <%= number_to_human_size(@update.apk_size) %>
                                    </span>
                                </div>
                            <% end %>
                        </div>
                        
                        <div class="apk-actions">
                            <a href="<%= @update.apk_url %>" target="_blank" class="btn btn-secondary">
                                üíæ Download APK
                            </a>
                        </div>
                    </div>
                <% else %>
                    <div class="no-apk">
                        <div class="no-apk-icon">üìÅ</div>
                        <p><strong>No APK uploaded</strong></p>
                        <p>An APK file is required before this update can be published.</p>
                        <% unless @update.published? %>
                            <a href="<%= edit_admin_update_path(@update) %>" class="btn btn-primary" style="margin-top: 15px;">
                                üì§ Upload APK
                            </a>
                        <% end %>
                    </div>
                <% end %>
            </div>

            <!-- Metadata -->
            <div class="metadata-section">
                <h3>üîß Technical Metadata</h3>
                <div class="metadata-grid">
                    <div class="metadata-item">
                        <span class="metadata-label">Update ID</span>
                        <span class="metadata-value"><%= @update.update_id %></span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">Created At</span>
                        <span class="metadata-value"><%= @update.created_at.iso8601 %></span>
                    </div>
                    <% if @update.published_at %>
                        <div class="metadata-item">
                            <span class="metadata-label">Published At</span>
                            <span class="metadata-value"><%= @update.published_at.iso8601 %></span>
                        </div>
                    <% end %>
                    <% if @update.apk_key.present? %>
                        <div class="metadata-item">
                            <span class="metadata-label">APK Key</span>
                            <span class="metadata-value"><%= @update.apk_key %></span>
                        </div>
                    <% end %>
                </div>
            </div>

            <!-- Danger Zone -->
            <% unless @update.published? %>
                <div class="danger-zone">
                    <h3>‚ö†Ô∏è Danger Zone</h3>
                    <p>Once you delete this update, there is no going back. Please be certain.</p>
                    <button onclick="deleteUpdate()" class="btn btn-danger">
                        üóëÔ∏è Delete Update
                    </button>
                </div>
            <% end %>
        </div>
    </div>

    <!-- Toast Messages -->
    <% if flash[:success] %>
        <div class="toast success show" id="toast">
            <%= flash[:success] %>
        </div>
    <% elsif flash[:error] %>
        <div class="toast error show" id="toast">
            <%= flash[:error] %>
        </div>
    <% end %>

    <script>
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const updateId = '<%= @update.id %>';
        const updateVersion = 'v<%= @update.version %>';

        class UpdateViewer {
            constructor() {
                this.initializeToast();
            }

            initializeToast() {
                const toast = document.getElementById('toast');
                if (toast) {
                    setTimeout(() => {
                        toast.classList.remove('show');
                        setTimeout(() => toast.remove(), 300);
                    }, 4000);
                }
            }

            async makeRequest(url, method = 'POST') {
                try {
                    const response = await fetch(url, {
                        method,
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': csrfToken
                        },
                        credentials: 'same-origin'
                    });

                    return response;
                } catch (error) {
                    console.error('Request failed:', error);
                    throw error;
                }
            }

            showToast(message, type = 'success') {
                const existingToast = document.querySelector('.toast');
                if (existingToast) {
                    existingToast.remove();
                }

                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => toast.classList.add('show'), 100);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            }

            async publishUpdate() {
                if (!confirm('Are you sure you want to publish this update? Users will receive it immediately.')) {
                    return;
                }

                try {
                    const response = await this.makeRequest(`/admin/updates/${updateId}/publish`, 'PATCH');
                    
                    if (response.ok) {
                        this.showToast('Update published successfully!', 'success');
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        throw new Error('Failed to publish update');
                    }
                } catch (error) {
                    this.showToast('Failed to publish update', 'error');
                    console.error('Publish error:', error);
                }
            }

            async unpublishUpdate() {
                if (!confirm('Are you sure you want to unpublish this update?')) {
                    return;
                }

                try {
                    const response = await this.makeRequest(`/admin/updates/${updateId}/unpublish`, 'PATCH');
                    
                    if (response.ok) {
                        this.showToast('Update unpublished successfully!', 'success');
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        throw new Error('Failed to unpublish update');
                    }
                } catch (error) {
                    this.showToast('Failed to unpublish update', 'error');
                    console.error('Unpublish error:', error);
                }
            }

            async deleteUpdate() {
                if (!confirm(`Are you sure you want to delete ${updateVersion}? This action cannot be undone.`)) {
                    return;
                }

                const secondConfirm = prompt('Type "DELETE" to confirm deletion:');
                if (secondConfirm !== 'DELETE') {
                    this.showToast('Deletion cancelled', 'error');
                    return;
                }

                try {
                    const response = await this.makeRequest(`/admin/updates/${updateId}`, 'DELETE');
                    
                    if (response.ok) {
                        this.showToast('Update deleted successfully!', 'success');
                        setTimeout(() => window.location.href = '/admin/updates', 1500);
                    } else {
                        throw new Error('Failed to delete update');
                    }
                } catch (error) {
                    this.showToast('Failed to delete update', 'error');
                    console.error('Delete error:', error);
                }
            }
        }

        // Initialize the viewer
        let updateViewer;
        document.addEventListener('DOMContentLoaded', () => {
            updateViewer = new UpdateViewer();
        });

        // Global functions for button onclick handlers
        function publishUpdate() {
            updateViewer.publishUpdate();
        }

        function unpublishUpdate() {
            updateViewer.unpublishUpdate();
        }

        function deleteUpdate() {
            updateViewer.deleteUpdate();
        }
    </script>
</body>
</html>